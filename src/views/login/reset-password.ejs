<%- include('../partials/head.ejs') %>

<body
    class="min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center p-4">
    <div>
        <div
            class="bg-slate-800/95 backdrop-blur-lg rounded-2xl p-10 w-full max-w-md shadow-2xl border border-white/10 animate-fade-in">
            <!-- Header -->
            <div class="text-center mb-8">
                <!-- Lock Icon -->
                <div
                    class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-5 shadow-lg shadow-blue-500/30">
                    <svg class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" />
                    </svg>
                </div>
                <!-- Title -->
                <h1 class="text-white text-2xl font-semibold mb-2">Restablecer Contraseña</h1>
                <p class="text-white/70 text-sm leading-relaxed">
                    Crea una nueva contraseña segura para tu cuenta
                </p>
            </div>


            <!-- Form -->
            <form id="resetForm" class="space-y-6">
                <input type="hidden" name="token" id="token" value="<%= token %>">
                <!-- New Password Input -->
                <div>
                    <label for="newPassword" class="block text-white/90 text-sm font-medium mb-2">
                        Nueva Contraseña
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-4 h-4 text-white/60" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" />
                            </svg>
                        </div>
                        <input type="password" id="newPassword"
                            class="w-full bg-white/10 border border-white/20 rounded-lg pl-11 pr-12 py-3 text-white placeholder-white/50 text-sm focus:outline-none focus:border-blue-500 focus:ring-3 focus:ring-blue-500/20 focus:bg-white/15 transition-all duration-300"
                            placeholder="Ingresa tu nueva contraseña" required minlength="8">
                        <button type="button" onclick="togglePassword('newPassword', 'toggleNew')"
                            class="absolute inset-y-0 right-0 flex items-center pr-3.5 text-white/60 hover:text-white/80 transition-colors">
                            <svg id="toggleNew" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                            </svg>
                        </button>
                    </div>
                    <!-- Password Strength Indicator -->
                    <div class="mt-2">
                        <div class="flex space-x-1 mb-1">
                            <div id="strength1"
                                class="h-1 w-1/4 bg-white/20 rounded-full transition-colors duration-300"></div>
                            <div id="strength2"
                                class="h-1 w-1/4 bg-white/20 rounded-full transition-colors duration-300"></div>
                            <div id="strength3"
                                class="h-1 w-1/4 bg-white/20 rounded-full transition-colors duration-300"></div>
                            <div id="strength4"
                                class="h-1 w-1/4 bg-white/20 rounded-full transition-colors duration-300"></div>
                        </div>
                        <p id="strengthText" class="text-xs text-white/60">Fortaleza de la contraseña</p>
                    </div>
                </div>

                <!-- Confirm Password Input -->
                <div>
                    <label for="confirmPassword" class="block text-white/90 text-sm font-medium mb-2">
                        Confirmar Contraseña
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3.5 pointer-events-none">
                            <svg class="w-4 h-4 text-white/60" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12,17A2,2 0 0,0 14,15C14,13.89 13.1,13 12,13A2,2 0 0,0 10,15A2,2 0 0,0 12,17M18,8A2,2 0 0,1 20,10V20A2,2 0 0,1 18,22H6A2,2 0 0,1 4,20V10C4,8.89 4.9,8 6,8H7V6A5,5 0 0,1 12,1A5,5 0 0,1 17,6V8H18M12,3A3,3 0 0,0 9,6V8H15V6A3,3 0 0,0 12,3Z" />
                            </svg>
                        </div>
                        <input type="password" id="confirmPassword"
                            class="w-full bg-white/10 border border-white/20 rounded-lg pl-11 pr-12 py-3 text-white placeholder-white/50 text-sm focus:outline-none focus:border-blue-500 focus:ring-3 focus:ring-blue-500/20 focus:bg-white/15 transition-all duration-300"
                            placeholder="Confirma tu nueva contraseña" required>
                        <button type="button" onclick="togglePassword('confirmPassword', 'toggleConfirm')"
                            class="absolute inset-y-0 right-0 flex items-center pr-3.5 text-white/60 hover:text-white/80 transition-colors">
                            <svg id="toggleConfirm" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z" />
                            </svg>
                        </button>
                    </div>
                    <p id="matchMessage" class="text-xs mt-1 transition-all duration-300"></p>
                </div>

                <!-- Submit Button -->
                <button type="submit"
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold py-3.5 px-4 rounded-lg transition-all duration-300 hover:shadow-lg hover:shadow-blue-500/40 hover:-translate-y-0.5 active:translate-y-0 focus:outline-none focus:ring-3 focus:ring-blue-500/50">
                    <span id="submitText">Restablecer Contraseña</span>
                </button>

                <!-- Back Button -->
                <a href="/login"
                    class="w-full bg-transparent border border-white/30 text-white/90 font-medium py-3.5 px-4 rounded-lg transition-all duration-300 hover:bg-white/10 hover:border-white/50 focus:outline-none focus:ring-3 focus:ring-white/20 flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z" />
                    </svg>
                    Volver al Inicio de Sesión
                    <a />
            </form>

            <!-- Footer -->

        </div>
        <div class="mt-8 pt-6 border-t border-white/10 text-center">
            <p class="text-white/50 text-xs">
                © 2025 Soluciones Tecnológicas .NET. Todos los derechos reservados.
            </p>
        </div>
    </div>
    <script>
        // Password visibility toggle
        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);

            if (input.type === 'password') {
                input.type = 'text';
                icon.innerHTML = '<path d="M11.83,9L15,12.16C15,12.11 15,12.05 15,12A3,3 0 0,0 12,9C11.94,9 11.89,9 11.83,9M7.53,9.8L9.08,11.35C9.03,11.56 9,11.77 9,12A3,3 0 0,0 12,15C12.22,15 12.44,14.97 12.65,14.92L14.2,16.47C13.53,16.8 12.79,17 12,17A5,5 0 0,1 7,12C7,11.21 7.2,10.47 7.53,9.8M2,4.27L4.28,6.55L4.73,7C3.08,8.3 1.78,10 1,12C2.73,16.39 7,19.5 12,19.5C13.55,19.5 15.03,19.2 16.38,18.66L16.81,19.09L19.73,22L21,20.73L3.27,3M12,7A5,5 0 0,1 17,12C17,12.64 16.87,13.26 16.64,13.82L19.57,16.75C21.07,15.5 22.27,13.86 23,12C21.27,7.61 17,4.5 12,4.5C10.6,4.5 9.26,4.75 8,5.2L10.17,7.35C10.76,7.13 11.37,7 12,7Z"/>';
            } else {
                input.type = 'password';
                icon.innerHTML = '<path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/>';
            }
        }

        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            const indicators = ['strength1', 'strength2', 'strength3', 'strength4'];
            const strengthText = document.getElementById('strengthText');

            // Reset indicators
            indicators.forEach(id => {
                document.getElementById(id).className = 'h-1 w-1/4 bg-white/20 rounded-full transition-colors duration-300';
            });

            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/)) strength++;
            if (password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/) || password.match(/[^a-zA-Z0-9]/)) strength++;

            const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
            const texts = ['Muy débil', 'Débil', 'Buena', 'Fuerte'];
            const textColors = ['text-red-400', 'text-orange-400', 'text-yellow-400', 'text-green-400'];

            for (let i = 0; i < strength; i++) {
                document.getElementById(indicators[i]).className = `h-1 w-1/4 ${colors[strength - 1]} rounded-full transition-colors duration-300`;
            }

            if (password.length > 0) {
                strengthText.textContent = texts[strength - 1] || 'Muy débil';
                strengthText.className = `text-xs ${textColors[strength - 1] || 'text-red-400'}`;
            } else {
                strengthText.textContent = 'Fortaleza de la contraseña';
                strengthText.className = 'text-xs text-white/60';
            }

            return strength;
        }

        // Password match checker
        function checkPasswordMatch() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchMessage = document.getElementById('matchMessage');

            if (confirmPassword.length === 0) {
                matchMessage.textContent = '';
                return true;
            }

            if (newPassword === confirmPassword) {
                matchMessage.textContent = '✓ Las contraseñas coinciden';
                matchMessage.className = 'text-xs mt-1 text-green-400 transition-all duration-300';
                return true;
            } else {
                matchMessage.textContent = '✗ Las contraseñas no coinciden';
                matchMessage.className = 'text-xs mt-1 text-red-400 transition-all duration-300';
                return false;
            }
        }

        // Event listeners
        document.getElementById('newPassword').addEventListener('input', function () {
            checkPasswordStrength(this.value);
            checkPasswordMatch();
        });

        document.getElementById('confirmPassword').addEventListener('input', checkPasswordMatch);

        document.getElementById('resetForm').addEventListener('submit', async e => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const submitText = document.getElementById('submitText');

            if (newPassword !== confirmPassword) {
                this.classList.add('animate-shake');
                setTimeout(() => this.classList.remove('animate-shake'), 500);
                return;
            }

            if (checkPasswordStrength(newPassword) < 2) {
                alert('La contraseña debe ser más fuerte');
                return;
            }

            const token = document.getElementById('token').value;
            const object = {
                newPassword: newPassword,
                confirmPassword: confirmPassword,
                token: token,
            };

            try {
                const res = await fetch(`/login/resetPassword/${token}`, {
                    method: 'POST', headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(object)
                });
                const data = await res.json();

                if (!res.ok) {
                    Swal.fire('Error', data.errorMessage, 'error');
                    return
                }

                Swal.fire('¡Enviado!', data.successMessage, 'success').then(() => {
                    submitBtn.disabled = true;
                    setInterval(() => {
                        submitText.textContent = 'Redirigiendo...';
                    }, 1000);
                    window.location.href = '/login';
                });


            } catch (err) {
                console.log(err);

                Swal.fire('Error', "paso algio" || data.errorMessage, 'error');
            }

        });

    </script>
</body>

</html>